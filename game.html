<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Match Ten</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
      html {
        font-family: sans-serif;
      }

      body {
        background-color: darkslategrey;
        color: white;
        display: block;
        margin-left: auto;
        margin-right: auto;
        width: 50%;
      }
      #field {
        max-width: 550px;
        height: 600px;
        margin-top: 80px;
        overflow-x: auto;
        font-family:sans-serif;
        padding:10px;
        -moz-transform: scale(1.3);
      }
      #field button .invisible{
        margin: 2px;
        background: transparent !important;
        border: none !important;
        color: transparent !important;
      }
      #field button{
        margin: 2px;
        animation: shift 1s;
      }
      .highlight {
        border: solid 2px red;
      }
      @keyframes shift {
          from { transform: translateY(-300px) }
          to   { transform: translateY(0px) }
      }
    </style>
  </head>

  <body>
    <h1>Match Ten</h1>
    <div class="container">
      <br><br>
      <div class="row">
        <div class="col-md-1" style="margin-right:100px">
          <div class="row">
            <button class="btn btn-success" title="Hinzufügen" onclick="addRow()"> +</button>
          </div>
          <br>
          <div class="row">
            <button class="btn btn-danger" title="Hinweis" onclick="help()"> ?</button>
          </div>
          <br>
          <div class="row">
            <button class="btn btn-primary" title="Rückgängig" onclick="goback()">	&#x21A9; </button>
          </div>
          <br><br><br>
          <div class="row">
            <button class="btn btn-primary" title="Neu laden" onclick="location.reload()"> &#x21BA; </button>
          </div>
        </div>

        <div id="col-md-11">
          <div id="field"></div>
        </div>
      
      </div>
    </div>
    <br>
    <h3 style="display: none;">Leider kein Match möglich - Gib auf oder füge eine neue Reihe hinzu!</h3>

    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var removed = 0;
      var hist = [null,null,null];

      window.onload = function () {
        for (var i = 0; i < 30; i++) {
          var newInput = document.createElement("button");
          newInput.classList = "match btn btn-lg btn-light";
          newInput.id = ""+i;
          newInput.textContent = Math.floor(Math.random() * 9 + 1);
          newInput.onclick = function (event) {
            clickButton(event);
          };
          $("#field").append(newInput);
        }
      }

      function goback(){
        for(var g = 2; g >= 0; g--){
          if(hist[g] != null){
            $("#field").replaceWith(hist[g])
            $(".match").click(function(event){
              clickButton(event)
            })
            hist[g] = null;
            break;
          }
        }
      }

      function help(){
        var found = false;
        var pos1 = -1;
        var pos2 = -1;

        var values = []
        var buttons = $("#field button")
        for(var i = 0; i<buttons.length; i++){
          if($(buttons[i]).hasClass("match")){
            values.push(parseInt($(buttons[i]).html(),10));
          } else {
            values.push(-1);
          }
        }
        
        var last = $($("button .match").last()[0]).attr("id");
        var start = true;
        console.log(buttons.length)
        for(var i=0; i < buttons.length && values[i] != -1 && !found; i++){
          for(var j=1; j < buttons.length && j != i && values[j] != -1 && !found; j++){
            console.log(i + "," + "j: "+values[i] + "," + values[j])
            if(start && (values[i] == values[j] || values[i]+values[j] == 10)){
              found = true;
            }else if((j+1==i || j-1==i) && (values[i] == values[j] || values[i]+values[j] == 10)){
              found = true;
            } else if(i % 10 == j % 10 && (values[i] == values[j] || values[i]+values[j] == 10)){
              var x = i < j? i: j;
              var y = i < j? j: i;
              while(x < y && x < buttons.length){
                if(x+10 < y){
                  if(values[x+10] != -1){
                    break;
                  }
                } else {
                  found = true;
                }
                x += 10;
              }
            }
            if(found){
              pos1 = i;
              pos2 = j;
            }
          }
          start = false;
        }
        /*
          for(var j = 1; j<matches.length && !found && matches[i].id != matches[j].id; j++){
            var s0 = matches[i];
            var s1 = matches[j];
            var next = s0.nextSibling;
            var count = 0;
            while (
              next != null && next.classList.contains("invisible") &&
              count++ < 100
            ) {
              next = next.nextSibling;
            }
            count = 0;
            var prev = s0.previousSibling;
            while (
              prev != null && prev.classList.contains("invisible") &&
              count++ < 100
            ) {
              prev = prev.previousSibling;
            }
            var first = matches.first();
            var last = matches.last();
            var v0 = parseInt(s0.id, 10);
            var v1 = parseInt(s1.id, 10);
            var isNext = false;
            /*if ((v1 - v0) % 10 == 0) {
              if (v0 == v1 + 10 || v0 == v1 - 10) {
                isNext = true;
              } else {
                isNext = true;
                var matches = $(".match");
                var abs = Math.abs(v0 - v1) % 10;
                for (var j = 0; j < abs; j++) {
                  console.log("if matches at " + j*10 + " true, no match");
                  if (matches[j * 10]) {
                    isNext = false;
                  }
                }
              }
            }
            if ( (next != null && s1.id == next.id) || (prev != null && s1.id == prev.id) || isNext ||
              (s1.id == first.id && s0.id == last.id) || (s0.id == first.id && s1.id == last.id)) {
              if (parseInt(s0.textContent, 10) + parseInt(s1.textContent, 10) == 10 ||
                  parseInt(s0.textContent, 10) == parseInt(s1.textContent, 10)) {
                pos1 = s0.id;
                pos2 = s1.id;
                found = true;
                break;
              }
            }
          }
        }  */        
        if(found){
          $($("#field button")[pos1]).addClass("highlight");
          $($("#field button")[pos2]).addClass("highlight");
        } else {
          $("#nomatch").show();
        }
      }

      function addRow() {
        $("#nomatch").hide();
        hist.shift();
        hist.push($("#field").clone());
        var matches = $(".match");
        var iterations = matches.length;
        for (i = 0; i < iterations; i++) {
          var newInput = document.createElement("button");
          newInput.classList = "match btn btn-lg btn-light";
          newInput.id = ""+$("#field button").length;
          newInput.textContent = matches[i].textContent;
          newInput.onclick = function (event) {
            clickButton(event);
          };
          $("#field").append(newInput);
        }
        console.log("added " + iterations + " buttons")
        for (i = 0; i < 10 - (iterations % 10) && iterations % 10 != 0; i++) {
          var newInput = document.createElement("button");
          newInput.id = ""+$("#field button").length;
          newInput.textContent = "0"
          newInput.classList = "invisible btn btn-lg btn-light";
          $("#field").append(newInput);
          console.log("added 1 button")
        }
      }

      function clickButton(event) {
        var button = event.target;
        if (!button.classList.contains("selected")) {
          button.classList.add("selected");
        } else {
          button.classList.remove("selected");
        }
        var selected = $(".selected");
        if (selected.length > 1) {
          var s0 = selected[0];
          var s1 = selected[1];
          $(".selected").each(function(){
            $(this).removeClass("selected");
          })
          var next = s0.nextSibling;
          var count = 0;
          while (
            next != null && next.classList.contains("invisible") &&
            count++ < 100
          ) {
            next = next.nextSibling;
          }
          count = 0;
          var prev = s0.previousSibling;
          while (
            prev != null && prev.classList.contains("invisible") &&
            count++ < 100
          ) {
            prev = prev.previousSibling;
          }
          var first = $(".match").first()[0];
          var last = $(".match").last()[0];
          var v0 = parseInt(s0.id, 10);
          var v1 = parseInt(s1.id, 10);
          var isNext = false;
          if ((v1 - v0) % 10 == 0) {
            if (v0 == v1 + 10 || v0 == v1 - 10) {
              isNext = true;
            } else {
              isNext = true;
              var matches = $(".match");
              var abs = Math.abs(v0 - v1) % 10;
              for (var j = 0; j < abs; j++) {
                console.log("if matches at " + j*10 + " true, no match")
                if (matches[j * 10]) {
                  isNext = false;
                }
              }
            }
          }
          if ( (next != null && s1.id == next.id) || (prev != null && s1.id == prev.id) || isNext ||
            (s1.id == first.id && s0.id == last.id) || (s0.id == first.id && s1.id == last.id)) {
            if (parseInt(s0.textContent, 10) + parseInt(s1.textContent, 10) == 10 ||
                parseInt(s0.textContent, 10) == parseInt(s1.textContent, 10)) {
              hist.shift();
              hist.push($("#field").clone());
              s0.classList="btn btn-light btn-lg invisible";
              s1.classList="btn btn-light btn-lg invisible";
              removed += 2;
            }
          }
          
          if (removed >= 10) {

            var rowsDeleted = false;
            var startElements = [];
            $(".invisible").each(function(){
              if($(this).attr("id").slice(-1) == "0"){
                console.log("start element added:" + $(this).attr("id"))
                startElements.push(this);
              }
            });
            for(var h = 0; h < startElements.length; h++){
              var current = $(startElements[h])
              var deleteRow = true;
              var counter = 9;
              while(current != null && counter-- >= 0 && deleteRow){
                if($(current).hasClass("match")){
                  deleteRow = false;
                }
                current = $(current).next();
              }
              if(deleteRow){
                var removeIndex = parseInt($(startElements[h]).attr("id"),10);
                console.log("removing " + removeIndex)
                console.log("anzahl buttons: "+ $("#field button").length)
                for(var l = removeIndex+9; l>=removeIndex; l--){
                  console.log("aaand " + l)
                  $("#field button")[l].remove();
                }
                rowsDeleted = true;
              }
            }

            if (rowsDeleted) {
              renderField();
            }
          }
        }
      }
      
      function renderField(){
        var buttons = $("#field button");
        for (var j = 0; j < buttons.length; j++) {
          buttons[j].id = ""+j;
          if(buttons[j].classList.contains("match")){
            buttons[j].onclick = function(event){
              clickButton(event);
            }
          }
        }
        var matches = $(".match");
        if (matches.length == 0) {
          swal("Good job!", "You won!", "success",{
            button: "OK cool",
          });
        }
      }
    </script>
  </body>
</html>
